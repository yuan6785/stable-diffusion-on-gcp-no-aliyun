1. 在自定义ubuntu里面部署filestore的公共Python环境和sd公共环境(只用部署一次，后面filesstore里面即可用这个python环境)
    ----进入ubuntu---
    kubectl  exec -it   -n default $(kubectl get pods  -n default  |grep ubuntu |awk '{print $1}' |awk NR==1)   /bin/bash
    防止vim的时候中文乱码: 搜索笔记【securecrt乱码的原因两种】看最后ubuntu的那一段即可
    ------在filestore里面安装anconda------------
    mkdir -p /yuanxiao_root_nfs/sdwebui_public/versions/sdwebui_env
    cd /yuanxiao_root_nfs/sdwebui_public
    wget https://repo.anaconda.com/miniconda/Miniconda3-py38_23.1.0-1-Linux-x86_64.sh
    bash Miniconda3-py38_23.1.0-1-Linux-x86_64.sh -b -p -f /yuanxiao_root_nfs/sdwebui_public/versions/sdwebui_env/miniconda3
    --- 激活conda环境 ---
    /yuanxiao_root_nfs/sdwebui_public/versions/sdwebui_env/miniconda3/bin/conda init
    source ~/.bashrc
    --- 创建一个虚拟环境---
    conda create -y --name sd_python310_20230907 python=3.10
    conda activate sd_python310_20230907
    pip install aws-shell==0.2.2 # 用于同步s3的模型
    --- 测试gradio是否能提供公网访问(pod内没有service)--测试成功，可以访问 ---
    0yxgithub/userful_scripts/gradio_test/test_browse_donwload_inner_fastapi_onefile.py


2. 同步s3的模型到filestore
   笔记搜索[awss3sync常用命令sdwebui云函数nas同步备份webui]
   同步路径: /yuanxiao_root_nfs/sdwebui_public


3. 重新打包sdwebui并调试(后面有sd镜像升级，可以从这一步开始)
   参考打包基础镜像: /0yxgithub/stable-diffusion-on-gcp-no-aliyun/Stable-Diffusion-UI-Agones/sd-webui-yx/readme.txt
      
4. 新增或修改支持minio的域名(可选)
   域名在: /0yxgithub/stable-diffusion-on-gcp-no-aliyun/Stable-Diffusion-UI-Agones/sd-webui-yx/dockerdata/nginx2.conf 里面有三个
   sdwebui和supervisor共用一个域名用nignx的rewrite来区分
   minio-web需要根路径，所以需要单独一个域名
   minio-api也需要根路径，所以需要单独一个域名
   ---
   参考 /0yxgithub/stable-diffusion-on-gcp-no-aliyun/Stable-Diffusion-UI-Agones/ingress-iap/readme_yx.txt  如何新增域名

5. 修改fleet的sd的挂载路径(访问supervisor在域名后面加/psuperfaa/即可)
   
    第一种方法(测试成功):
        修改/0yxgithub/stable-diffusion-on-gcp-no-aliyun/Stable-Diffusion-UI-Agones/sd-webui-yx/sd-agones-fleet-std.yaml 里面需要修改的,特别是镜像版本，有注释---重要---
        cd /Users/yuanxiao/workspace/0yxgithub/stable-diffusion-on-gcp-no-aliyun/Stable-Diffusion-UI-Agones/sd-webui-yx
        kubectl delete fleet sd-agones-fleet
        kubectl apply -f sd-agones-fleet-std.yaml 即可, 会重新创建gameserver， 如果需要修改自动弹缩,打开文件里面最后的注释即可
        # kubectl scale fleet sd-agones-fleet --replicas=5  # 这个命令可以修改自动弹缩的数量

    第二种方法(比较保险):
        kubectl get fleet sd-agones-fleet -o yaml > sd-agones-fleet-tmp.yaml
        修改 sd-agones-fleet-tmp.yaml
        #########
        template:
            spec:
                ...
                containers:
                - name: stable-diffusion-webui
                    image: us-central1-docker.pkg.dev/happyaigc/sd-repository-c8c84f4c/sd-webui:xxx # 修改这里为上面的镜像
                ...
                - command:   # 这里改成自己的启动命令
                - /bin/sh
                - -c
                - start_supervisor2.sh
        ...
        volumeMounts:
        - mountPath: /yuanxiao_root_nfs  # 修改这里
            name: stable-diffusion-storage
            subPath: " "
        
        #########
        kubectl apply -f sd-agones-fleet-tmp.yaml
        rm -rf sd-agones-fleet-tmp.yaml
    
    注意： 重新部署fleet后，需要参考------重要------
          /0yxgithub/stable-diffusion-on-gcp-no-aliyun/最新版本的部署方式(首先看这个).txt
          第八点 调试以及重要理解  ----- 清理redis的数据，否则会出现用户502的问题

5. 进入gs进行调试，或者进入gs看日志
   # 这个gs的pod因为是多容器的，所以进入的时候要指定容器，这里指定的是stable-diffusion-webui即可
   kubectl  exec -it   -n default gs的pod的name  -c stable-diffusion-webui  /bin/bash
   例如:
   kubectl  exec -it   -n default sd-agones-fleet-p4kbn-7dzw5  -c stable-diffusion-webui  /bin/bash
   # /usr/sbin/nginx -s reload  nignx重启命令

6. 后期如果需要不走iap认证走自己的认证可以参考
   0yxgithub/stable-diffusion-on-gcp-no-aliyun/Stable-Diffusion-UI-Agones/ingress-iap/yx-clean-ingress
   自己定义带lua的nginx和重定向到自己的认证服务即可